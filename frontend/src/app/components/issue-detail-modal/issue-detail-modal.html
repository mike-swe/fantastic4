<div class="modal-overlay" (click)="onBackdropClick($event)">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Issue Details</h2>
      <button class="modal-close-btn" (click)="onCancel()" type="button" aria-label="Close modal">
        Ã—
      </button>
    </div>

    @if (issue) {
      <div class="modal-content">
        <div class="issue-details-section">
          <div class="issue-header-info">
            <h3 class="issue-title-large">{{ issue.title }}</h3>
            <div class="issue-tags">
              <span 
                class="tag" 
                [style.background-color]="getStatusColor(issue.status)"
                [style.color]="'#ffffff'"
              >
                {{ issue.status.replace('_', ' ') }}
              </span>
              <span 
                class="tag" 
                [style.background-color]="getSeverityColor(issue.severity)"
                [style.color]="'#ffffff'"
              >
                {{ issue.severity }}
              </span>
              <span 
                class="tag" 
                [style.background-color]="getPriorityColor(issue.priority)"
                [style.color]="'#ffffff'"
              >
                {{ issue.priority }}
              </span>
            </div>
          </div>

          <div class="issue-description">
            <h4 class="section-title">Description</h4>
            <p class="description-text">{{ issue.description }}</p>
          </div>

          <div class="issue-meta-grid">
            <div class="meta-item">
              <span class="meta-label">Project</span>
              <span class="meta-value">{{ issue.project?.name || 'N/A' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Created By</span>
              <span class="meta-value">{{ issue.createdBy?.username || 'N/A' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Assigned To</span>
              <span class="meta-value">{{ issue.assignedTo?.username || 'Unassigned' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Created At</span>
              <span class="meta-value">{{ formatDate(issue.createdAt) }}</span>
            </div>
            @if (issue.updatedAt) {
              <div class="meta-item">
                <span class="meta-label">Last Updated</span>
                <span class="meta-value">{{ formatDate(issue.updatedAt) }}</span>
              </div>
            }
          </div>
        </div>

        <div class="history-section">
          <h4 class="section-title">History</h4>
          
          @if (isLoadingHistory()) {
            <div class="loading-state">
              <p>Loading history...</p>
            </div>
          } @else if (errorMessage()) {
            <div class="error-state">
              <p>{{ errorMessage() }}</p>
            </div>
          } @else if (history.length === 0) {
            <div class="empty-state">
              <p>No history available for this issue.</p>
            </div>
          } @else {
            <div class="history-timeline">
              @for (item of history; track item.id) {
                <div class="history-item">
                  <div class="history-item-header">
                    <div class="history-user-info">
                      <div class="user-avatar" [style.background-color]="'#3b82f6'">
                        {{ getUserInitials(item.changedByUser?.username) }}
                      </div>
                      <div class="history-user-details">
                        <span class="history-user-name">{{ item.changedByUser?.username || 'Unknown' }}</span>
                        <span class="history-timestamp">{{ formatDate(item.changedAt) }}</span>
                      </div>
                    </div>
                    <span class="history-change-type">{{ item.changeType.replace('_', ' ') }}</span>
                  </div>
                  <div class="history-change-description">
                    {{ formatChangeDescription(item) }}
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <div class="comments-section">
          <h4 class="section-title">Comments</h4>
          
          @if (isLoadingComments()) {
            <div class="loading-state">
              <p>Loading comments...</p>
            </div>
          } @else if (commentErrorMessage()) {
            <div class="error-state">
              <p>{{ commentErrorMessage() }}</p>
            </div>
          } @else if (comments.length === 0) {
            <div class="empty-state">
              <p>No comments yet. Be the first to comment!</p>
            </div>
          } @else {
            <div class="comments-list">
              @for (comment of comments; track comment.id) {
                <div class="comment-item">
                  <div class="comment-header">
                    <div class="comment-user-info">
                      <div class="user-avatar" [style.background-color]="'#3b82f6'">
                        {{ getUserInitials(comment.author?.username) }}
                      </div>
                      <div class="comment-user-details">
                        <span class="comment-user-name">{{ comment.author?.username || 'Unknown' }}</span>
                        <span class="comment-timestamp">{{ formatDate(comment.createdAt) }}</span>
                        @if (comment.updatedAt && comment.updatedAt !== comment.createdAt) {
                          <span class="comment-edited">(edited)</span>
                        }
                      </div>
                    </div>
                    <div class="comment-actions">
                      @if (editingCommentId === comment.id) {
                        <button 
                          class="btn-comment-action"
                          (click)="updateComment(comment.id)"
                        >
                          Save
                        </button>
                        <button 
                          class="btn-comment-action"
                          (click)="cancelEditing()"
                        >
                          Cancel
                        </button>
                      } @else {
                        @if (canEditComment(comment)) {
                          <button 
                            class="btn-comment-action"
                            (click)="startEditing(comment)"
                          >
                            Edit
                          </button>
                        }
                        @if (canDeleteComment(comment)) {
                          <button 
                            class="btn-comment-action btn-delete"
                            (click)="deleteComment(comment.id)"
                          >
                            Delete
                          </button>
                        }
                      }
                    </div>
                  </div>
                  @if (editingCommentId === comment.id) {
                    <textarea
                      class="comment-edit-textarea"
                      [(ngModel)]="editingCommentText"
                      rows="3"
                    ></textarea>
                  } @else {
                    <div class="comment-content">
                      {{ comment.content }}
                    </div>
                  }
                </div>
              }
            </div>
          }

          <div class="comment-form">
            <h5 class="comment-form-title">Add a comment</h5>
            <textarea
              class="comment-input"
              [(ngModel)]="newCommentText"
              placeholder="Write a comment..."
              rows="3"
            ></textarea>
            <button
              class="btn-comment-submit"
              (click)="createComment()"
              [disabled]="!newCommentText.trim()"
            >
              Post Comment
            </button>
          </div>
        </div>
      </div>
    }

    <div class="modal-footer">
      <button
        type="button"
        class="btn-close"
        (click)="onCancel()"
      >
        Close
      </button>
    </div>
  </div>
</div>

